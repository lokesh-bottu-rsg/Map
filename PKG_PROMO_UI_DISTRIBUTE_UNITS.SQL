CREATE OR REPLACE PROCEDURE PKG_PROMO_UI_DISTRIBUTE_UNITS(IN_CALL_ID INT)
RETURNS VARCHAR
LANGUAGE SQL AS 
BEGIN

    CREATE OR REPLACE TEMPORARY TABLE TMP_DISTRIBUTION_DATA AS 
    SELECT TRRC.PROJECT_ID,	TRRC.SPOT_RESULT,RCP.START_DATE,
    CASE WHEN TRRC.FLIGHT_START_DATE < TRRC.QTR_START_DATE 
    THEN DATEDIFF(DAY,TRRC.QTR_START_DATE,(SELECT START_DATE FROM REF_CAL_PERIOD RCP 
                                        WHERE CURRENT_TIMESTAMP() BETWEEN START_DATE AND END_DATE AND PERIOD_TYPE_CD = 'W'))
    ELSE DATEDIFF(DAY,TRRC.FLIGHT_START_DATE,(SELECT START_DATE FROM REF_CAL_PERIOD RCP 
                                        WHERE CURRENT_TIMESTAMP() BETWEEN START_DATE AND END_DATE AND PERIOD_TYPE_CD = 'W')) END ELAPSED_DAYS,
    DATEDIFF(DAY,CASE WHEN TRRC.FLIGHT_START_DATE < TRRC.QTR_START_DATE  
                        THEN TRRC.QTR_START_DATE  ELSE TRRC.FLIGHT_START_DATE END,TRRC.FLIGHT_END_DATE)+1 TOTAL_DAYS,
    7- (CASE WHEN TRRC.FLIGHT_START_DATE > RCP.START_DATE 
            THEN DATEDIFF(DAY,RCP.START_DATE,TRRC.FLIGHT_START_DATE) ELSE 0 END)
            - (CASE WHEN TRRC.FLIGHT_END_DATE < RCP.END_DATE
            THEN DATEDIFF(DAY,TRRC.FLIGHT_END_DATE,RCP.END_DATE) ELSE 0 END) DAYS_IN_WEEK,
    TRRC.CALC_BASED_ON 
    FROM REF_CAL_PERIOD RCP
    JOIN TEMP_REFRESH_REACH_CALCULATION TRRC ON RCP.START_DATE <= TRRC.FLIGHT_END_DATE AND RCP.PERIOD_TYPE_CD='W' AND TRRC.CALL_ID = 10811
    AND TRRC.CALC_BASED_ON NOT IN  ('S', 'ES')
    AND RCP.END_DATE >= CASE WHEN TRRC.FLIGHT_START_DATE < TRRC.QTR_START_DATE 
                THEN TRRC.QTR_START_DATE  ELSE TRRC.FLIGHT_START_DATE END
    JOIN PR_PROJECT PP ON PP.PROJECT_ID = TRRC.PROJECT_ID;


    INSERT INTO TMP_PROJECT_DISTRIBUTION (CALL_ID, PROJECT_ID, WEEK_DATE, UNIT_COUNT)
    SELECT :IN_CALL_ID CALL_ID,PROJECT_ID,START_DATE,
        CASE WHEN CALC_BASED_ON NOT IN ('ER', 'EG') THEN 
        
            CASE WHEN FLOOR((IFNULL(SPOT_RESULT,0) * DAYS_IN_WEEK) /TOTAL_DAYS) < 0 THEN 0
            ELSE 
                FLOOR((IFNULL(SPOT_RESULT,0) * DAYS_IN_WEEK) /TOTAL_DAYS) END
        ELSE 

            SPOT_RESULT
        END UNIT_COUNT FROM TMP_DISTRIBUTION_DATA;

RETURN 'SUCCESS';
END;


GRANT USAGE ON PROCEDURE PKG_PROMO_UI_DISTRIBUTE_UNITS(INT) TO ROLE RA_PROMO_DEV_QA_UAT_ACCESS;
GRANT USAGE ON PROCEDURE PKG_PROMO_UI_DISTRIBUTE_UNITS(INT) TO ROLE RA_PROMO_PROD_ACCESS;