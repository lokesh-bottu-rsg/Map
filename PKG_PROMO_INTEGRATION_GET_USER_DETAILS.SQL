CREATE OR REPLACE PROCEDURE PKG_PROMO_INTEGRATION_GET_USER_DETAILS(IN_EXEC_ID INT)
RETURNS TABLE (MEDIA_OUTLET_ID INT, NETWORK_CODE VARCHAR(20), BROADCAST_DATE DATE, EMAIL VARCHAR(100), 
    NAME VARCHAR(100), PLAN_NAME VARCHAR(100), QUARTER VARCHAR(100), PLAN_TYPE VARCHAR(100), MODEL_TYPE_ID INT, 
    EXEC_STATUS VARCHAR(4), VERSION_NO VARCHAR(7))
LANGUAGE SQL AS 
DECLARE 
    V_MODEL_TYPE INT;
    RES RESULTSET;
BEGIN

	SELECT MODEL_TYPE_ID INTO :V_MODEL_TYPE FROM MODEL_EXEC WHERE MODEL_EXEC_ID = :IN_EXEC_ID;
	 
	IF (:V_MODEL_TYPE = 2 OR :V_MODEL_TYPE = 4) THEN
		RES := (
            SELECT  
            PL.MEDIA_OUTLET_ID,
            RMO.SHORT_NAME NETWORK_CODE,
            PL.BROADCAST_DATE,
            SU.USER_NAME EMAIL,
            CONCAT(SU.FIRST_NAME,' ',SU.LAST_NAME) NAME,
            NULL PLAN_NAME,
            NULL QUARTER,
            CASE WHEN PLV.STATUS=15 THEN 'Re-Timing' ELSE 'Optimization' END PLAN_TYPE,
            :V_MODEL_TYPE MODEL_TYPE_ID,
            ME.EXEC_STATUS_CD EXEC_STATUS,
            PLV.SUB_LOG_VERSION_ID AS VERSION_NO
            FROM PR_LOG_VERSION PLV JOIN PR_LOG PL 	
            ON PLV.LOG_ID=PL.LOG_ID
            JOIN MODEL_EXEC ME ON PLV.LOG_VERSION_ID = ME.PLAN_VERSION_ID
            AND ME.MODEL_EXEC_ID= :IN_EXEC_ID
            JOIN SEC_USER SU ON SU.USER_ID=ME.USER_ID
            JOIN REF_MEDIA_OUTLET RMO 
            ON RMO.MEDIA_OUTLET_ID=PL.MEDIA_OUTLET_ID
        );

	ELSE

		RES := (
            SELECT  
            PL.MEDIA_OUTLET_ID,
            RMO.SHORT_NAME NETWORK_CODE,
            NULL BROADCAST_DATE,
            SU.USER_NAME EMAIL,
            CONCAT(SU.FIRST_NAME,' ',SU.LAST_NAME) NAME,
            PL.NAME PLAN_NAME,
            RCP.FISCAL_QTR QUARTER,
            CASE WHEN IFNULL(OPTIMIZATION_TYPE,0)=0 THEN 'Optimize' ELSE 'Distribute' END PLAN_TYPE,
            :V_MODEL_TYPE MODEL_TYPE_ID,
            PLV.EXEC_STATUS_CD EXEC_STATUS,
            NULL AS VERSION_NO
            FROM MODEL_EXEC PLV JOIN PR_PLAN PL 
            ON PLV.MODEL_EXEC_ID=:IN_EXEC_ID AND PLV.PLAN_ID=PL.PLAN_ID  
            INNER JOIN PR_PLAN_VERSION PPV ON PPV.PLAN_ID=PLV.PLAN_ID AND PLV.PLAN_VERSION_ID=PPV.PLAN_VERSION_ID
            JOIN REF_MEDIA_OUTLET RMO 
            ON RMO.MEDIA_OUTLET_ID=PL.MEDIA_OUTLET_ID
            JOIN SEC_USER SU ON SU.USER_ID=PLV.USER_ID
            INNER JOIN REF_CAL_PERIOD RCP 
            ON PL.PERIOD_ID=RCP.PERIOD_ID 
            AND RCP.PERIOD_TYPE_CD='Q' 
            WHERE PLV.MODEL_EXEC_ID= :IN_EXEC_ID
        );
	END IF;    
    RETURN TABLE(RES);
END;

GRANT USAGE ON PROCEDURE PKG_PROMO_INTEGRATION_GET_USER_DETAILS(INT) TO ROLE RA_PROMO_DEV_QA_UAT_ACCESS;
GRANT USAGE ON PROCEDURE PKG_PROMO_INTEGRATION_GET_USER_DETAILS(INT) TO ROLE RA_PROMO_PROD_ACCESS;