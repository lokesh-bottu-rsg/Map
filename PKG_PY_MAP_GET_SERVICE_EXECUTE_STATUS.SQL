CREATE OR REPLACE PROCEDURE PKG_PY_MAP_GET_SERVICE_EXECUTE_STATUS(IN_MODEL_EXEC_ID INT)
RETURNS TABLE (MODEL_EXEC_ID INT, SERVER_PATH VARCHAR, SERVER_ID INT, STATUS VARCHAR(20))
LANGUAGE SQL AS 
DECLARE 
    V_SWITCH INT;
    V_LICENSE_ID INT;
    V_STATUS VARCHAR(5);
    V_ID INT;
    RES RESULTSET;
BEGIN

		SELECT PM.VALUE, ME.EXEC_STATUS_CD,ME.LICENSE_ID INTO :V_SWITCH, :V_STATUS ,:V_LICENSE_ID
        FROM PR_MODEL_EXEC_PARAM PM JOIN MODEL_EXEC ME ON PM.MODEL_EXEC_ID = ME.MODEL_EXEC_ID
		WHERE ME.MODEL_EXEC_ID = :IN_MODEL_EXEC_ID AND PM.PARAM_ID = 39;
        
        select SERVER_ID into :V_ID from MODEL_LICENSE where LICENSE_ID=:V_LICENSE_ID;
        
        IF (:V_ID IS NULL) THEN 
			SELECT 1 INTO :V_ID;
        END IF;
        
	IF (:V_STATUS = 'IC' AND :V_SWITCH = 1)THEN

        UPDATE MODEL_EXEC SET PYTHON_SERVER_ID = :V_ID WHERE MODEL_EXEC_ID = :IN_MODEL_EXEC_ID;
        
		RES := (SELECT :IN_MODEL_EXEC_ID AS MODEL_EXEC_ID, PYTHON_SERVICE_PATH AS SERVER_PATH,
        SERVER_ID AS SERVER_ID, 'ENABLE' AS STATUS  
        FROM PYTHON_PARALLEL_EXECUTIONS WHERE ID = :V_ID);

	ELSE 
		
        RES := (SELECT :IN_MODEL_EXEC_ID AS MODEL_EXEC_ID, NULL AS SERVER_PATH, NULL::INT AS SERVER_ID, 'DISABLE' AS STATUS) ;
		
	END IF;

RETURN TABLE(RES);
END;

GRANT USAGE ON PROCEDURE PKG_PY_MAP_GET_SERVICE_EXECUTE_STATUS(INT) TO ROLE RA_PROMO_DEV_QA_UAT_ACCESS;
GRANT USAGE ON PROCEDURE PKG_PY_MAP_GET_SERVICE_EXECUTE_STATUS(INT) TO ROLE RA_PROMO_PROD_ACCESS;